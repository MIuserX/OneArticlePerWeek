## 原文

https://severalnines.com/database-blog/postgresql-streaming-replication-deep-dive



## 翻译

​		高可用对于管理 PG 的管理员来说是必须的。这是个历久弥新的主题。这篇文章中，我们回顾一点 PG 内置的主从复制的历史，并深入理解流复制是如何工作的。

​		讨论主从复制时，还会讨论一些 WAL 的知识。所以，先来看一些 WAL 的知识。

### Write Ahead Log（WAL）

​		WAL 是保证数据完整性的标准方法，PG 默认是开启这个功能的。

​		WAL 是 PG 中的 REDO Log。但是，什么是 REDO Log 呢？

​		REDO Log 包含了数据库中的所有变更，被应用于主从复制、数据恢复、在线备份、时间点恢复(PITR)。任何没有应用到实际数据页的变化都可以通过 REDO Log 重放。

​		使用 WAL 可以明显地减小磁盘写地数量，因为只有 Log 文件需要被刷写到磁盘来保证事务被提交，而不是刷写每个被事务改变的数据文件。

​		一个 WAL Record 将会一点点的记录数据的变化。每个 WAL Record 将会被添加到一个 WAL 文件。插入位置是一个 LSN ，这个 LSN 在日志中的一个字节偏移，每个新 Record 增加一次。

​		WAL 文件被存储在数据目录下的 pg_xlog（PG 10是 pg_wal）目录，这些 WAL 文件默认每个 16MB（这个大小可以在构建服务器的时候用 `--with-wal-segsize`  改变）。每个日志文件拥有一个唯一的自增的名字，以格式：“0000001 00000000 00000000”。

​		pg_xlog（pg_wal）下的 WAL 文件的数量取决于 postgresql.conf 配置文件中的参数 `checkpoint_segments`（或者 `min_wal_size` 和 `max_wal_size` ，参数名字取决于 PG 版本）。

​		我们安装所有 PG 实例时都需要设置的一个参数是 `wal_level` 。这参数决定 WAL 中记录信息的详细程度。默认值是 `minimal` ，这仅仅只在 WAL 中记录发生 crash 或 immediate shutdown 进行恢复时所需的信息。

 		-- todo



### History Of Replication In PG

​		PG 实现的第一个主从复制方法(温备)(version 8.2，2006年)是基于 日志传送方法。

​		这意味着，WAL 记录是直接从一个数据库服务器移动到另一个服务器，然后应用。我们可以说这是个 PITR。

​		PostgreSQL 实现了基于文件的日志传送通过传送 WAL 记录一次一个文件（WAL Segment）。

​		这个主从复制实现有个缺点：如果在主库上存在一个主要错误，至今还没有被传送的事务将会丢失。所以有一个数据丢失窗口（你可以使用 `archive_timeout` 参数调整这个，这个参数可以设置低一点，几秒就行，但这样一个低的设置将会大体上增加文件传输需要的带宽）。

​		我们可以用下图表示这个方法：

![img](https://severalnines.com/sites/default/files/blog/node_5266/image1.jpg)



​		所以，在 PG 9.0（2010年），流复制产生了。

​		这个特性允许我们

